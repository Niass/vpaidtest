var adBase64 = "eyJ0YWdfaW5mb3MiOnsic3RpY2t5IjpbeyJpZCI6Njc0NywicG9zaXRpb24iOiJib3R0b21fcmVzcG9uc2l2ZSIsInBsYXRmb3JtX2lkIjoyLCJvcHRpb25zIjoyfV0sImZvcm1hdCI6MywiZGlzcGxheV90eXBlIjoic3RpY2t5In0sImNyZWF0aXZlIjp7ImJhbm5lciI6eyJoZWlnaHQiOjIwMCwid2lkdGgiOjQwMCwiYWRtIjoiXHUwMDNjaWZyYW1lIHNyYz1cImh0dHBzOi8vY3JlYXRpdmUuYmxpaW5rLmlvL2xlZ29fc3RhcndhcnNfZGlvcmFtYXNfZnVsbHN3aXRjaHZpZGVvXzIvZGVtby9pbmRleC5odG1sP2NiPTE2NjQyNzE4NjJcdTAwMjZnZHByPTFcdTAwMjZnZHByX2NvbnNlbnQ9Q1BwWXZzQVBwWXZzQUFHQUJDRU5DOUNzQVBfQUFIX0FBQWJJSk5OTjdDX19hV05qLTM1OVFmdDBlWTFmOTlwM3J1UWhEaGFKZzZRRjFMUENzTHdWd21FNk5FM29waW9LbUJZRU8xTEFJUUJsSElIVUJRR0Fhb2tSb1RIc2FrMk1KZ0FBSjdKRWtnTVpVbWRJR0ZWTm0xbERtWUlZejN3LTByYVIyQzROUk52TXhNemhQNFZQM1dONXRzMTZxSERUVng4WWhiSDFjQUFCQUFBQVFvQUFBQUFBQUFBQUFBQUFBQkFBRUFCQUFBRUVoQUNCQVJFSUlDQkRBQUdBQkFDQUFBRUtZa0FBQUFBQVFBQVFBQUFDZ2dBRUZZQUNDQ0JBQUFFQUFBRUFBQVFFSU1BQUFBQUFBUWdBQUFBc0VBZ0FBZ0VBQUlBQVFBQUFCQVFDQUFBZ0JBQUFBQUNRRVFBZ0FBQWdJSUFBQUlBd0lBQUFnZ0FRQUFBQUFpUXdBQURpQ0FFZ0FRSVJBQUFSQUFBZ0FBQWdBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQUFBQWdJaElGQUFDQUFGZ0FWQUF5QUJ3QUR3QUlJQWFBQnFBRHlBSWdBaWdCTUFEZUFITUFQUUFmb0JFQUVTQUpZQVRRQXBRQmJnRERBR1dBUHNBZm9CRkFDVEFGUEFORUFiUUEzQUI4Z0VPZ0pFQVUwQXRnQmtnRFBnR2tBTllnY21CeWdVQUVBSW9CMjRRQUNBdHdOQU5BQzRBTXNBZllCQlFDVEFGUGdMUUF0SUIxUUQ1QUlkQVNJQXo0QnlnaUFXQU1zQWZZQkpnQ25nSFZBUGtBaDBCSWdESXdHZkFPVUZRQ1FBbUFCY0FFY0FNdUF0QUMwZ0xZQVpHQXo0QnlneUFRQUV3QVJ3QXl3Q3RnTFlBWkdBejRCeWc2Qm9BQXNBQ29BR1FBT0FBZ0FCakFEUUFOUUFlQUEtZ0NJQUlvQVRBQXVBQmlBRE1BRzhBT1lBZWdBX0FDSUFFc0FKb0FVWUFwUUJiZ0REQUdVQU5FQWZZQV9RQ0tBRWRBSk1BVS1BdEFDMGdGNUFOd0FkUUEtd0NIUUVpQUprQVUwQXRpQmtZR1NBTXNBWm1BejRCcEFEV0lISmdjb0JBRUNPdzhBR0FDb0FSUUR0eHdBRUJiaENBeUFBc0FESUFNUUFhZ0JNQUM0QUdJQU13QWJ3QTlBQ09BRktBTW9BZllCRkFDbndGb0FXa0E2Z0NSQUZOQUxLQVd3QXlNQm53RGxDSUFJQUZRQ1lpVUNBQUJBQUN3QU1nQWNBQS1BREVBSGdBUkFBbUFCY0FERUFHYUFSQUJFZ0NqQUZLQUxjQVpRQS13Q253Rm9BV2tBM0FCMUFENUFJZEFTSUF0Z0JrWURMQUdmQU5JQWF3QkFFa0FCQVc0VWdVQUFMQUFxQUJrQURnQUlBQVl3QTBBRFVBSGtBUkFCRkFDWUFGSUFNUUFaZ0E1Z0ItQUVRQUtNQVVvQXR3QmxBRFJBSDJBUjBBcllCZVFEYUFHNEFQc0FoMEJJZ0NUZ0ZzUU1qQXlRQmxnRFBnR2tBTllnY21CeWdEeFFJN0ZRQVFBS2dBZkZBQUlDM0FBQS5mX2dBQUFBQUFBQUFcdTAwMjZpc1N0aWNreT10cnVlXHUwMDI2aXNQcmViaWQ9ZmFsc2UjY2xpY2s9aHR0cHM6Ly9lLmFwaS5ibGlpbmsuaW8vYz90b2tlbj1leUpoYkdjaU9pSklVekkxTmlJc0luUjVjQ0k2SWtwWFZDSjkuZXlKbGVIQWlPakUyT0RjNE5qRXhPRGdzSW1saGRDSTZNVFk0TnpJMU5qTTRPQ3dpYVhOeklqb2lZbXhwYVc1cklpd2laR0YwWVNJNmV5SjBlWEJsSWpvaVlXUXRjMlZ5ZG1WeUlpd2lkSEpoYm5OaFkzUnBiMjVKWkNJNklqTTBZbUkyTmpSbExXRmpNekV0TkdFeVl5MWlOVEUzTFRrNE5USTFNVGMwWkdOaU1DSXNJbTVsZEhkdmNtdEpaQ0k2T1RFc0luTnBkR1ZKWkNJNk56azRMQ0owWVdkSlpDSTZOREEyTkN3aVkyOXZhMmxsU1dRaU9pSXdZV1prWlRsa05DMW1ZbVJpTFRRMVkySXRZVGxtT1MwNVpEVTVPR0V6WmpVME1UWWlMQ0psZG1WdWRFbGtJam96TENKMFlYSm5aWFJwYm1jaU9uc2ljR3hoZEdadmNtMGlPaUpOYjJKcGJHVWdWMlZpYzJsMFpTSXNJbkJoWjJWVmNtd2lPaUpvZEhSd2N6b3ZMM0JvYjNSdkxtTmhiV2x1ZEdWeVpYTnpaUzVtY2k5MmIybGphUzFqWlMxeGRXbHNMWE5sTFhCaGMzTmxMWEYxWVc1a0xXOXVMVzFsZFhKMExUUXhNalUxSWl3aWFYQWlPaUl5WVRBeE9tVXdZVHBpTTJFNlpXTmxNRG8xTmpFNk1UVTFOenBpTWpoaU9tWmxOellpTENKMGFXMWxJam94TmpnM01qVTJNemc0TENKc2IyTmhkR2x2YmlJNmV5SnNZWFJwZEhWa1pTSTZORGN1TXpNd05pd2liRzl1WjJsMGRXUmxJam95TGpnek1Ua3NJbkpsWjJsdmJpSTZJa05XVENJc0ltTnZkVzUwY25raU9pSkdVaUlzSW1OcGRIa2lPaUpUWVc1alpYSnlaU0lzSW5wcGNFTnZaR1VpT2lJeE9ETXdNQ0lzSW1SbGNHRnlkRzFsYm5RaU9pSXhPQ0o5TENKamFYUjVJam9pVTJGdVkyVnljbVVpTENKamIzVnVkSEo1SWpvaVJsSWlMQ0pwYm5SbGNtNWxkRU52Ym01bFkzUnBiMjVVZVhCbElqb2lkVzVyYm05M2JpSXNJbVJsZG1salpVOXpJam9pYVU5VElpd2laR1YyYVdObFRXOWtaV3dpT2lKcFVHaHZibVVpTENKa1pYWnBZMlZRYkdGMFptOXliU0k2SWsxdlltbHNaU0JYWldKemFYUmxJaXdpY21GM1ZYTmxja0ZuWlc1MElqb2lUVzk2YVd4c1lTODFMakFnS0dsUWFHOXVaVHNnUTFCVklHbFFhRzl1WlNCUFV5QXhNMTh5WHpNZ2JHbHJaU0JOWVdNZ1QxTWdXQ2tnUVhCd2JHVlhaV0pMYVhRdk5qQTFMakV1TVRVZ0tFdElWRTFNTENCc2FXdGxJRWRsWTJ0dktTQldaWEp6YVc5dUx6RXpMakF1TXlCTmIySnBiR1V2TVRWRk1UUTRJRk5oWm1GeWFTODJNRFF1TVNKOUxDSm5aSEJ5SWpwN0ltaGhjME52Ym5ObGJuUWlPblJ5ZFdVc0ltTnZibk5sYm5SVGRISnBibWNpT2lKRFVIQlpkbk5CVUhCWmRuTkJRVWRCUWtORlRrTTVRM05CVUY5QlFVaGZRVUZCWWtsS1RrNU9OME5mWDJGWFRtb3RNelU1VVdaME1HVlpNV1k1T1hBemNuVlJhRVJvWVVwbk5sRkdNVXhRUTNOTWQxWjNiVVUyVGtVemIzQnBiMHR0UWxsRlR6Rk1RVWxSUW14SVNVaFZRbEZIUVdGdmExSnZWRWh6WVdzeVRVcG5RVUZLTjBwRmEyZE5XbFZ0WkVsSFJsWk9iVEZzUkcxWlNWbDZNM2N0TUhKaFVqSkRORTVTVG5aTmVFMTZhRkEwVmxBelYwNDFkSE14Tm5GSVJGUldlRGhaYUdKSU1XTkJRVUpCUVVGQlVXOUJRVUZCUVVGQlFVRkJRVUZCUVVGQ1FVRkZRVUpCUVVGRlJXaEJRMEpCVWtWSlNVTkNSRUZCUjBGQ1FVTkJRVUZGUzFsclFVRkJRVUZCVVVGQlVVRkJRVU5uWjBGRlJsbEJRME5EUWtGQlFVVkJRVUZGUVVGQlVVVkpUVUZCUVVGQlFVRlJaMEZCUVVGelJVRm5RVUZuUlVGQlNVRkJVVUZCUVVKQlVVTkJRVUZuUWtGQlFVRkJRMUZGVVVGblFVRkJaMGxKUVVGQlNVRjNTVUZCUVdkblFWRkJRVUZCUVdsUmQwRkJSR2xEUVVWblFWRkpVa0ZCUVZKQlFVRm5RVUZCWjBGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCWjBsb1NVWkJRVU5CUVVablFWWkJRWGxCUW5kQlJIZEJTVWxCWVVGQ2NVRkVlVUZKWjBGcFowSk5RVVJsUVVoTlFWQlJRV1p2UWtWQlJWTkJTbGxCVkZGQmNGRkNZbWRFUkVGSFYwRlFjMEZtYjBKR1FVTlVRVVpRUVU1RlFXSlJRVE5CUWpoblJVOW5Ta1ZCVlRCQmRHZENhMmRFVUdkSGEwRk9XV2RqYlVKNVoxVkJSVUZKYjBJeU5GRkJRMEYwZDA1QlRrRkRORUZOYzBGbVdVSkNVVU5VUVVaUVoweFJRWFJKUWpGUlJEVkJTV1JCVTBsQmVqUkNlV2RwUVZkQlRYTkJabGxDU21kRGJtZElWa0ZRYTBGb01FSkpaMFJKZDBkbVFVOVZSbEZEVVVGdFFVSmpRVVZqUVUxMVFYUkJRekJuVEZsQldrZEJlalJDZVdkNVFWRkJSWGRCVW5kQmVYZERkR2RNV1VGYVIwRjZORUo1WnpaQ2IwRkJjMEZEYjBGSFVVRlBRVUZuUVVKcVFVUlJRVTVSUVdWQlFTMW5RMGxCU1c5QlZFRkJkVUZDYVVGRVRVRkhPRUZQV1VGbFowRmZRVU5KUVVWelFVcHZRVlZaUVhCUlFtSm5SRVJCUjFWQlRrVkJabGxCWDFGRFMwRkZaRUZLVFVGVkxVRjBRVU13WjBZMVFVNTNRV1JSUVMxM1EwaFJSV2xCU210QlZUQkJkR2xDYTFsSFUwRk5jMEZhYlVGNk5FSndRVVJYU1VoS1oyTnZRa0ZGUTA5M09FRkhRVU52UVZKUlJIUjRkMEZGUW1Kb1EwRjVRVUZ6UVVSSlFVMVJRV0ZuUWsxQlF6UkJSMGxCVFhkQlluZEJPVUZEVDBGR1MwRk5iMEZtV1VKR1FVTnVkMFp2UVZkclFUWm5RMUpCUms1QlRFdEJWM2RCZVUxQ2JuZEViRU5KUVVsQlJsRkRXV2xWUTBGQlFrRkJRM2RCVFdkQlkwRkJMVUZFUlVGSVowRlNRVUZ0UVVKalFVUkZRVWRoUVZKQlFrVm5RMnBCUmt0QlRHTkJXbEZCTFhkRGJuZEdiMEZYYTBFelFVSXhRVVExUVVsa1FWTkpRWFJuUW10WlJFeEJSMlpCVGtsQllYZENRVVZyUVVKQlZ6UlZaMVZCUVV4QlFYRkJRbXRCUkdkQlNVRkJXWGRCTUVGRVZVRklhMEZTUVVKR1FVTlpRVVpKUVUxUlFWcG5RVFZuUWkxQlJWRkJTMDFCVlc5QmRIZENiRUZFVWtGSU1rRlNNRUZ5V1VKbFVVUmhRVWMwUVZCelFXZ3dRa2xuUTFSblJuTlJUV3BCZVZGQ2JHZEVVR2RIYTBGT1dXZGpiVUo1WjBSNFVVazNSbEZCVVVGTFowRm1Sa0ZCU1VNelFVRkJMbVpmWjBGQlFVRkJRVUZCUVNKOUxDSnVjQ0k2SWt0U0swNXBjRTFsWjNwRWQycExkM2xKV0hkcmVVRTlQU0lzSW1kd0lqb2lOeXRPVkZZeEt5dExiVnAzWkhBNGJrMVhkelJwZHowOUlpd2laVzVqVkhBaU9pSkxVaXRPYVhCTlpXZDZSSGRxUzNkNVNWaDNhM2xCUFQwaUxDSmxibU5FWlcwaU9pSkJlVmhKUkhCT2QyZzVNbGxETldsUVkzZG5SM3AzUFQwaUxDSm1iR0ZuY3lJNk5Td2lZM1Z5Y21WdVkza2lPaUpGVlZJaUxDSjNhVzRpT21aaGJITmxMQ0ptYjNKdFlYUWlPak1zSW1ScGMzQnNZWGxVZVhCbElqb2ljM1JwWTJ0NUlpd2lZV1JKWkNJNk1UWXhOalVzSW1Ga2RtVnlkR2x6WlhKSlpDSTZNU3dpWTJGdGNHRnBaMjVKWkNJNk9EWXpMQ0pqY21WaGRHbDJaVWxrSWpvME5UWTFMQ0psY25KdmNpSTZabUZzYzJWOWZRLkJBc1Z5Q0lRb0FRYndQdVdGT0Zoa2g3RzZLNzFtWTVZaU14ZHpkZGlZQk1cdTAwMjZyZWRpcmVjdD1cIiBzdHlsZT1cImhlaWdodDogMTAwJTsgd2lkdGg6IDEwMCU7IGJvcmRlcjogMDtcIlx1MDAzZVx1MDAzYy9pZnJhbWVcdTAwM2VcdTAwM2NzY3JpcHQgc3JjPVwiaHR0cHM6Ly90YWcuYmxpaW5rLmlvL2NyZWF0aXZlLm1pbi5qcz9jYj0xNjg3MTY3OTg5XCJcdTAwM2VcdTAwM2Mvc2NyaXB0XHUwMDNlXHUwMDNjaW1nIHNyYz0naHR0cHM6Ly9lLmFwaS5ibGlpbmsuaW8vaS5naWY/bmFtZT1pbXByZXNzaW9uXHUwMDI2dG9rZW49ZXlKaGJHY2lPaUpJVXpJMU5pSXNJblI1Y0NJNklrcFhWQ0o5LmV5SmxlSEFpT2pFMk9EYzROakV4T0Rnc0ltbGhkQ0k2TVRZNE56STFOak00T0N3aWFYTnpJam9pWW14cGFXNXJJaXdpWkdGMFlTSTZleUowZVhCbElqb2lZV1F0YzJWeWRtVnlJaXdpZEhKaGJuTmhZM1JwYjI1SlpDSTZJak0wWW1JMk5qUmxMV0ZqTXpFdE5HRXlZeTFpTlRFM0xUazROVEkxTVRjMFpHTmlNQ0lzSW01bGRIZHZjbXRKWkNJNk9URXNJbk5wZEdWSlpDSTZOems0TENKMFlXZEpaQ0k2TkRBMk5Dd2lZMjl2YTJsbFNXUWlPaUl3WVdaa1pUbGtOQzFtWW1SaUxUUTFZMkl0WVRsbU9TMDVaRFU1T0dFelpqVTBNVFlpTENKbGRtVnVkRWxrSWpvekxDSjBZWEpuWlhScGJtY2lPbnNpY0d4aGRHWnZjbTBpT2lKTmIySnBiR1VnVjJWaWMybDBaU0lzSW5CaFoyVlZjbXdpT2lKb2RIUndjem92TDNCb2IzUnZMbU5oYldsdWRHVnlaWE56WlM1bWNpOTJiMmxqYVMxalpTMXhkV2xzTFhObExYQmhjM05sTFhGMVlXNWtMVzl1TFcxbGRYSjBMVFF4TWpVMUlpd2lhWEFpT2lJeVlUQXhPbVV3WVRwaU0yRTZaV05sTURvMU5qRTZNVFUxTnpwaU1qaGlPbVpsTnpZaUxDSjBhVzFsSWpveE5qZzNNalUyTXpnNExDSnNiMk5oZEdsdmJpSTZleUpzWVhScGRIVmtaU0k2TkRjdU16TXdOaXdpYkc5dVoybDBkV1JsSWpveUxqZ3pNVGtzSW5KbFoybHZiaUk2SWtOV1RDSXNJbU52ZFc1MGNua2lPaUpHVWlJc0ltTnBkSGtpT2lKVFlXNWpaWEp5WlNJc0lucHBjRU52WkdVaU9pSXhPRE13TUNJc0ltUmxjR0Z5ZEcxbGJuUWlPaUl4T0NKOUxDSmphWFI1SWpvaVUyRnVZMlZ5Y21VaUxDSmpiM1Z1ZEhKNUlqb2lSbElpTENKcGJuUmxjbTVsZEVOdmJtNWxZM1JwYjI1VWVYQmxJam9pZFc1cmJtOTNiaUlzSW1SbGRtbGpaVTl6SWpvaWFVOVRJaXdpWkdWMmFXTmxUVzlrWld3aU9pSnBVR2h2Ym1VaUxDSmtaWFpwWTJWUWJHRjBabTl5YlNJNklrMXZZbWxzWlNCWFpXSnphWFJsSWl3aWNtRjNWWE5sY2tGblpXNTBJam9pVFc5NmFXeHNZUzgxTGpBZ0tHbFFhRzl1WlRzZ1ExQlZJR2xRYUc5dVpTQlBVeUF4TTE4eVh6TWdiR2xyWlNCTllXTWdUMU1nV0NrZ1FYQndiR1ZYWldKTGFYUXZOakExTGpFdU1UVWdLRXRJVkUxTUxDQnNhV3RsSUVkbFkydHZLU0JXWlhKemFXOXVMekV6TGpBdU15Qk5iMkpwYkdVdk1UVkZNVFE0SUZOaFptRnlhUzgyTURRdU1TSjlMQ0puWkhCeUlqcDdJbWhoYzBOdmJuTmxiblFpT25SeWRXVXNJbU52Ym5ObGJuUlRkSEpwYm1jaU9pSkRVSEJaZG5OQlVIQlpkbk5CUVVkQlFrTkZUa001UTNOQlVGOUJRVWhmUVVGQllrbEtUazVPTjBOZlgyRlhUbW90TXpVNVVXWjBNR1ZaTVdZNU9YQXpjblZSYUVSb1lVcG5ObEZHTVV4UVEzTk1kMVozYlVVMlRrVXpiM0JwYjB0dFFsbEZUekZNUVVsUlFteElTVWhWUWxGSFFXRnZhMUp2VkVoellXc3lUVXBuUVVGS04wcEZhMmROV2xWdFpFbEhSbFpPYlRGc1JHMVpTVmw2TTNjdE1ISmhVakpETkU1U1RuWk5lRTE2YUZBMFZsQXpWMDQxZEhNeE5uRklSRlJXZURoWmFHSklNV05CUVVKQlFVRkJVVzlCUVVGQlFVRkJRVUZCUVVGQlFVRkNRVUZGUVVKQlFVRkZSV2hCUTBKQlVrVkpTVU5DUkVGQlIwRkNRVU5CUVVGRlMxbHJRVUZCUVVGQlVVRkJVVUZCUVVOblowRkZSbGxCUTBORFFrRkJRVVZCUVVGRlFVRkJVVVZKVFVGQlFVRkJRVUZSWjBGQlFVRnpSVUZuUVVGblJVRkJTVUZCVVVGQlFVSkJVVU5CUVVGblFrRkJRVUZCUTFGRlVVRm5RVUZCWjBsSlFVRkJTVUYzU1VGQlFXZG5RVkZCUVVGQlFXbFJkMEZCUkdsRFFVVm5RVkZKVWtGQlFWSkJRVUZuUVVGQlowRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlowbG9TVVpCUVVOQlFVWm5RVlpCUVhsQlFuZEJSSGRCU1VsQllVRkNjVUZFZVVGSlowRnBaMEpOUVVSbFFVaE5RVkJSUVdadlFrVkJSVk5CU2xsQlZGRkJjRkZDWW1kRVJFRkhWMEZRYzBGbWIwSkdRVU5VUVVaUVFVNUZRV0pSUVROQlFqaG5SVTluU2tWQlZUQkJkR2RDYTJkRVVHZEhhMEZPV1dkamJVSjVaMVZCUlVGSmIwSXlORkZCUTBGMGQwNUJUa0ZETkVGTmMwRm1XVUpDVVVOVVFVWlFaMHhSUVhSSlFqRlJSRFZCU1dSQlUwbEJlalJDZVdkcFFWZEJUWE5CWmxsQ1NtZERibWRJVmtGUWEwRm9NRUpKWjBSSmQwZG1RVTlWUmxGRFVVRnRRVUpqUVVWalFVMTFRWFJCUXpCblRGbEJXa2RCZWpSQ2VXZDVRVkZCUlhkQlVuZEJlWGREZEdkTVdVRmFSMEY2TkVKNVp6WkNiMEZCYzBGRGIwRkhVVUZQUVVGblFVSnFRVVJSUVU1UlFXVkJRUzFuUTBsQlNXOUJWRUZCZFVGQ2FVRkVUVUZIT0VGUFdVRmxaMEZmUVVOSlFVVnpRVXB2UVZWWlFYQlJRbUpuUkVSQlIxVkJUa1ZCWmxsQlgxRkRTMEZGWkVGS1RVRlZMVUYwUVVNd1owWTFRVTUzUVdSUlFTMTNRMGhSUldsQlNtdEJWVEJCZEdsQ2ExbEhVMEZOYzBGYWJVRjZORUp3UVVSWFNVaEtaMk52UWtGRlEwOTNPRUZIUVVOdlFWSlJSSFI0ZDBGRlFtSm9RMEY1UVVGelFVUkpRVTFSUVdGblFrMUJRelJCUjBsQlRYZEJZbmRCT1VGRFQwRkdTMEZOYjBGbVdVSkdRVU51ZDBadlFWZHJRVFpuUTFKQlJrNUJURXRCVjNkQmVVMUNibmRFYkVOSlFVbEJSbEZEV1dsVlEwRkJRa0ZCUTNkQlRXZEJZMEZCTFVGRVJVRklaMEZTUVVGdFFVSmpRVVJGUVVkaFFWSkJRa1ZuUTJwQlJrdEJUR05CV2xGQkxYZERibmRHYjBGWGEwRXpRVUl4UVVRMVFVbGtRVk5KUVhSblFtdFpSRXhCUjJaQlRrbEJZWGRDUVVWclFVSkJWelJWWjFWQlFVeEJRWEZCUW10QlJHZEJTVUZCV1hkQk1FRkVWVUZJYTBGU1FVSkdRVU5aUVVaSlFVMVJRVnBuUVRWblFpMUJSVkZCUzAxQlZXOUJkSGRDYkVGRVVrRklNa0ZTTUVGeVdVSmxVVVJoUVVjMFFWQnpRV2d3UWtsblExUm5Sbk5SVFdwQmVWRkNiR2RFVUdkSGEwRk9XV2RqYlVKNVowUjRVVWszUmxGQlVVRkxaMEZtUmtGQlNVTXpRVUZCTG1aZlowRkJRVUZCUVVGQlFTSjlMQ0p1Y0NJNklrdFNLMDVwY0UxbFozcEVkMnBMZDNsSldIZHJlVUU5UFNJc0ltZHdJam9pTnl0T1ZGWXhLeXRMYlZwM1pIQTRiazFYZHpScGR6MDlJaXdpWlc1alZIQWlPaUpMVWl0T2FYQk5aV2Q2UkhkcVMzZDVTVmgzYTNsQlBUMGlMQ0psYm1ORVpXMGlPaUpCZVZoSlJIQk9kMmc1TWxsRE5XbFFZM2RuUjNwM1BUMGlMQ0ptYkdGbmN5STZOU3dpWTNWeWNtVnVZM2tpT2lKRlZWSWlMQ0ozYVc0aU9tWmhiSE5sTENKbWIzSnRZWFFpT2pNc0ltUnBjM0JzWVhsVWVYQmxJam9pYzNScFkydDVJaXdpWVdSSlpDSTZNVFl4TmpVc0ltRmtkbVZ5ZEdselpYSkpaQ0k2TVN3aVkyRnRjR0ZwWjI1SlpDSTZPRFl6TENKamNtVmhkR2wyWlVsa0lqbzBOVFkxTENKbGNuSnZjaUk2Wm1Gc2MyVjlmUS5CQXNWeUNJUW9BUWJ3UHVXRk9GaGtoN0c2SzcxbVk1WWlNeGR6ZGRpWUJNXHUwMDI2Y2I9MTY4NzI1NjM4ODc3MzQ3NzcyNicgYm9yZGVyPScwJyBoZWlnaHQ9JzEnIHdpZHRoPScxJ1x1MDAzZSJ9LCJtZWRpYV90eXBlIjoiYmFubmVyIn0sInByaWNlIjozLCJ0b2tlbiI6ImV5SmhiR2NpT2lKSVV6STFOaUlzSW5SNWNDSTZJa3BYVkNKOS5leUpsZUhBaU9qRTJPRGM0TmpFeE9EZ3NJbWxoZENJNk1UWTROekkxTmpNNE9Dd2lhWE56SWpvaVlteHBhVzVySWl3aVpHRjBZU0k2ZXlKMGVYQmxJam9pWVdRdGMyVnlkbVZ5SWl3aWRISmhibk5oWTNScGIyNUpaQ0k2SWpNMFltSTJOalJsTFdGak16RXROR0V5WXkxaU5URTNMVGs0TlRJMU1UYzBaR05pTUNJc0ltNWxkSGR2Y210SlpDSTZPVEVzSW5OcGRHVkpaQ0k2TnprNExDSjBZV2RKWkNJNk5EQTJOQ3dpWTI5dmEybGxTV1FpT2lJd1lXWmtaVGxrTkMxbVltUmlMVFExWTJJdFlUbG1PUzA1WkRVNU9HRXpaalUwTVRZaUxDSmxkbVZ1ZEVsa0lqb3pMQ0owWVhKblpYUnBibWNpT25zaWNHeGhkR1p2Y20waU9pSk5iMkpwYkdVZ1YyVmljMmwwWlNJc0luQmhaMlZWY213aU9pSm9kSFJ3Y3pvdkwzQm9iM1J2TG1OaGJXbHVkR1Z5WlhOelpTNW1jaTkyYjJsamFTMWpaUzF4ZFdsc0xYTmxMWEJoYzNObExYRjFZVzVrTFc5dUxXMWxkWEowTFRReE1qVTFJaXdpYVhBaU9pSXlZVEF4T21Vd1lUcGlNMkU2WldObE1EbzFOakU2TVRVMU56cGlNamhpT21abE56WWlMQ0owYVcxbElqb3hOamczTWpVMk16ZzRMQ0pzYjJOaGRHbHZiaUk2ZXlKc1lYUnBkSFZrWlNJNk5EY3VNek13Tml3aWJHOXVaMmwwZFdSbElqb3lMamd6TVRrc0luSmxaMmx2YmlJNklrTldUQ0lzSW1OdmRXNTBjbmtpT2lKR1VpSXNJbU5wZEhraU9pSlRZVzVqWlhKeVpTSXNJbnBwY0VOdlpHVWlPaUl4T0RNd01DSXNJbVJsY0dGeWRHMWxiblFpT2lJeE9DSjlMQ0pqYVhSNUlqb2lVMkZ1WTJWeWNtVWlMQ0pqYjNWdWRISjVJam9pUmxJaUxDSnBiblJsY201bGRFTnZibTVsWTNScGIyNVVlWEJsSWpvaWRXNXJibTkzYmlJc0ltUmxkbWxqWlU5eklqb2lhVTlUSWl3aVpHVjJhV05sVFc5a1pXd2lPaUpwVUdodmJtVWlMQ0prWlhacFkyVlFiR0YwWm05eWJTSTZJazF2WW1sc1pTQlhaV0p6YVhSbElpd2ljbUYzVlhObGNrRm5aVzUwSWpvaVRXOTZhV3hzWVM4MUxqQWdLR2xRYUc5dVpUc2dRMUJWSUdsUWFHOXVaU0JQVXlBeE0xOHlYek1nYkdsclpTQk5ZV01nVDFNZ1dDa2dRWEJ3YkdWWFpXSkxhWFF2TmpBMUxqRXVNVFVnS0V0SVZFMU1MQ0JzYVd0bElFZGxZMnR2S1NCV1pYSnphVzl1THpFekxqQXVNeUJOYjJKcGJHVXZNVFZGTVRRNElGTmhabUZ5YVM4Mk1EUXVNU0o5TENKblpIQnlJanA3SW1oaGMwTnZibk5sYm5RaU9uUnlkV1VzSW1OdmJuTmxiblJUZEhKcGJtY2lPaUpEVUhCWmRuTkJVSEJaZG5OQlFVZEJRa05GVGtNNVEzTkJVRjlCUVVoZlFVRkJZa2xLVGs1T04wTmZYMkZYVG1vdE16VTVVV1owTUdWWk1XWTVPWEF6Y25WUmFFUm9ZVXBuTmxGR01VeFFRM05NZDFaM2JVVTJUa1V6YjNCcGIwdHRRbGxGVHpGTVFVbFJRbXhJU1VoVlFsRkhRV0Z2YTFKdlZFaHpZV3N5VFVwblFVRktOMHBGYTJkTldsVnRaRWxIUmxaT2JURnNSRzFaU1ZsNk0zY3RNSEpoVWpKRE5FNVNUblpOZUUxNmFGQTBWbEF6VjA0MWRITXhObkZJUkZSV2VEaFphR0pJTVdOQlFVSkJRVUZCVVc5QlFVRkJRVUZCUVVGQlFVRkJRVUZDUVVGRlFVSkJRVUZGUldoQlEwSkJVa1ZKU1VOQ1JFRkJSMEZDUVVOQlFVRkZTMWxyUVVGQlFVRkJVVUZCVVVGQlFVTm5aMEZGUmxsQlEwTkRRa0ZCUVVWQlFVRkZRVUZCVVVWSlRVRkJRVUZCUVVGUlowRkJRVUZ6UlVGblFVRm5SVUZCU1VGQlVVRkJRVUpCVVVOQlFVRm5Ra0ZCUVVGQlExRkZVVUZuUVVGQlowbEpRVUZCU1VGM1NVRkJRV2RuUVZGQlFVRkJRV2xSZDBGQlJHbERRVVZuUVZGSlVrRkJRVkpCUVVGblFVRkJaMEZCUVVGQlFVRkJRVUZCUVVGQlFVRkJRVUZCUVVGQlFVRkJaMGxvU1VaQlFVTkJRVVpuUVZaQlFYbEJRbmRCUkhkQlNVbEJZVUZDY1VGRWVVRkpaMEZwWjBKTlFVUmxRVWhOUVZCUlFXWnZRa1ZCUlZOQlNsbEJWRkZCY0ZGQ1ltZEVSRUZIVjBGUWMwRm1iMEpHUVVOVVFVWlFRVTVGUVdKUlFUTkJRamhuUlU5blNrVkJWVEJCZEdkQ2EyZEVVR2RIYTBGT1dXZGpiVUo1WjFWQlJVRkpiMEl5TkZGQlEwRjBkMDVCVGtGRE5FRk5jMEZtV1VKQ1VVTlVRVVpRWjB4UlFYUkpRakZSUkRWQlNXUkJVMGxCZWpSQ2VXZHBRVmRCVFhOQlpsbENTbWREYm1kSVZrRlFhMEZvTUVKSlowUkpkMGRtUVU5VlJsRkRVVUZ0UVVKalFVVmpRVTExUVhSQlF6Qm5URmxCV2tkQmVqUkNlV2Q1UVZGQlJYZEJVbmRCZVhkRGRHZE1XVUZhUjBGNk5FSjVaelpDYjBGQmMwRkRiMEZIVVVGUFFVRm5RVUpxUVVSUlFVNVJRV1ZCUVMxblEwbEJTVzlCVkVGQmRVRkNhVUZFVFVGSE9FRlBXVUZsWjBGZlFVTkpRVVZ6UVVwdlFWVlpRWEJSUW1KblJFUkJSMVZCVGtWQlpsbEJYMUZEUzBGRlpFRktUVUZWTFVGMFFVTXdaMFkxUVU1M1FXUlJRUzEzUTBoUlJXbEJTbXRCVlRCQmRHbENhMWxIVTBGTmMwRmFiVUY2TkVKd1FVUlhTVWhLWjJOdlFrRkZRMDkzT0VGSFFVTnZRVkpSUkhSNGQwRkZRbUpvUTBGNVFVRnpRVVJKUVUxUlFXRm5RazFCUXpSQlIwbEJUWGRCWW5kQk9VRkRUMEZHUzBGTmIwRm1XVUpHUVVOdWQwWnZRVmRyUVRablExSkJSazVCVEV0QlYzZEJlVTFDYm5kRWJFTkpRVWxCUmxGRFdXbFZRMEZCUWtGQlEzZEJUV2RCWTBGQkxVRkVSVUZJWjBGU1FVRnRRVUpqUVVSRlFVZGhRVkpCUWtWblEycEJSa3RCVEdOQldsRkJMWGREYm5kR2IwRlhhMEV6UVVJeFFVUTFRVWxrUVZOSlFYUm5RbXRaUkV4QlIyWkJUa2xCWVhkQ1FVVnJRVUpCVnpSVloxVkJRVXhCUVhGQlFtdEJSR2RCU1VGQldYZEJNRUZFVlVGSWEwRlNRVUpHUVVOWlFVWkpRVTFSUVZwblFUVm5RaTFCUlZGQlMwMUJWVzlCZEhkQ2JFRkVVa0ZJTWtGU01FRnlXVUpsVVVSaFFVYzBRVkJ6UVdnd1FrbG5RMVJuUm5OUlRXcEJlVkZDYkdkRVVHZEhhMEZPV1dkamJVSjVaMFI0VVVrM1JsRkJVVUZMWjBGbVJrRkJTVU16UVVGQkxtWmZaMEZCUVVGQlFVRkJRU0o5TENKdWNDSTZJa3RTSzA1cGNFMWxaM3BFZDJwTGQzbEpXSGRyZVVFOVBTSXNJbWR3SWpvaU55dE9WRll4S3l0TGJWcDNaSEE0YmsxWGR6UnBkejA5SWl3aVpXNWpWSEFpT2lKTFVpdE9hWEJOWldkNlJIZHFTM2Q1U1ZoM2EzbEJQVDBpTENKbGJtTkVaVzBpT2lKQmVWaEpSSEJPZDJnNU1sbEROV2xRWTNkblIzcDNQVDBpTENKbWJHRm5jeUk2TlN3aVkzVnljbVZ1WTNraU9pSkZWVklpTENKM2FXNGlPbVpoYkhObExDSm1iM0p0WVhRaU9qTXNJbVJwYzNCc1lYbFVlWEJsSWpvaWMzUnBZMnQ1SWl3aVlXUkpaQ0k2TVRZeE5qVXNJbUZrZG1WeWRHbHpaWEpKWkNJNk1Td2lZMkZ0Y0dGcFoyNUpaQ0k2T0RZekxDSmpjbVZoZEdsMlpVbGtJam8wTlRZMUxDSmxjbkp2Y2lJNlptRnNjMlY5ZlEuQkFzVnlDSVFvQVFid1B1V0ZPRmhraDdHNks3MW1ZNVlpTXhkemRkaVlCTSIsIm1vZGUiOiJhZCIsImV4dHJhcyI6eyJkZWFsX2lkIjoiNDU2NSIsInRyYW5zYWN0aW9uX2lkIjoiMzRiYjY2NGUtYWMzMS00YTJjLWI1MTctOTg1MjUxNzRkY2IwIiwiY3JlYXRpdmUiOnsiYWRfaWQiOjE2MTY1LCJjYXRlZ29yeSI6MiwidHlwZSI6MSwidmlld2FiaWxpdHlfZHVyYXRpb24iOjEsInZpZXdhYmlsaXR5X3BlcmNlbnRfaW5fdmlldyI6MzB9fSwiY3VycmVuY3kiOiJFVVIifQ=="

async function sendEventWithToken(
  eventName,
  token,
  label
) {
  if (eventName && token) {
    let urlWithParams = `${EVENT_API_URL}/i.gif?token=${token}&name=${eventName}`;
    if (label && typeof label === "string") {
      urlWithParams = `${urlWithParams}&label=${label}`;
    }
    const [err, response] = await to(fetch(urlWithParams));

    if (response && response.ok) {
      const [, event] = await to(response.json());

      return event;
    }

    throw err;
  }

  throw new Error("Missing params");
}

const AdEvent = {
  CUSTOM : "custom",
}

const SCRIPT_LOADED_LABEL = "scriptLoaded";
const AdDisplayType = {
  UNIFY_STICKY: "unify_sticky",
  RESPONSIVE : "responsive",
  TOP_RESPONSIVE : "top_responsive",
  BOTTOM_RESPONSIVE : "bottom_responsive",
  STICKY : "sticky",
}
// Function to decode base64 encoded ad data
const adDecodeData = (encodedText) =>
  JSON.parse(atob(encodedText));

// Function to get the self window
function getWindowSelf() {
  return window.self;
}

// Function to get the top window
function getWindowTop() {
  return window.top;
}

// Function to check if the top window is accessible
function canAccessTopWindow() {
  try {
    if (getWindowTop().location.href) {
      return true;
    }
  } catch (error) {
    console.log("can t access top", error);
    return false;
  }
}

// Function to get the window context (either top window or self window)
function getWindowContext() {
  return canAccessTopWindow() ? getWindowTop() : getWindowSelf();
}

// Function to check if the current window is a SafeFrame
function isSafeFrameWindow() {
  const ws = getWindowSelf();
  return !!(ws.$sf && ws.$sf.ext);
}

// Function to check if the script is loaded in the context window
function isScriptLoaded(ad) {
  return !!getWindowContext().document.querySelector(`[data-id="${ad.extras.transaction_id}"]`);
}

// Function to retrieve ad data from the current script tag's dataset
function getAdData() {
  try {
    const ad = adDecodeData(adBase64);
    console.log("ad***", ad);
    if (!ad) {
      throw new Error("No Ad found on document.currentScript.dataset.ad");
    }
    return { ad, adm: adBase64 };
  } catch (error) {
    console.log("error getting currentScript.dataset.ad", error);
    return { ad: null, adm: null, format: null };
  }
}

function appendScriptElement(script, isOutsideIframe) {
  if (isOutsideIframe) {
    window.top.document.body.appendChild(script);
  } else {
    document.body.appendChild(script);
  }
}

function createScriptElement(ad, adm, isOutsideIframe) {
  console.log("event.data*** initialize createScriptElement", isOutsideIframe);
  const script = document.createElement("script");
  script.dataset.id = ad.extras.transaction_id;
  script.type = "text/javascript";
  script.async = true;
  script.src = `${urlScript}/creative.js?cb=${cacheBuster}`;
  script.dataset.ad = adm;
  script.dataset.format = isOutsideIframe ? AdDisplayType.STICKY : '';

  return script;
}

function isOutsideIframeAd(ad, format) {
  console.log("can t access top 2", format,ad);
  return !isSafeFrameWindow() && canAccessTopWindow() && ad.tag_infos.display_type
  === "sticky"
}

// const urlScript = process.env.BASE_URL ? process.env.BASE_URL : "https://prebid.bliink.io";
const urlScript = "http://localhost:3000";
const cacheBuster =  1;
console.log("document.currentScript", document.currentScript);
const { ad, adm, format } = getAdData();

if (ad?.creative) {
  if (canAccessTopWindow()) {
    // Store current iframe window in top window for later selection of the iframe
    const bliinksAds = window.top.bliinkLoadedAds || {};
    const currentAd = { window: getWindowSelf() };
    currentAd.isIframe = !!window.frameElement;
    bliinksAds[`bliink_ad_${ad?.extras?.transaction_id}`] = currentAd;
    window.top.bliinkLoadedAds = bliinksAds;

    // Add unique class to parent element for later selection of the placement
    if (!currentAd.isIframe) {
      document.currentScript.parentElement.classList.add(`bliink_ad_${ad?.extras?.transaction_id}`);
      document.currentScript.parentElement.dataset.bliinkAd = ad?.extras?.transaction_id;
    }
  }


  if (!isScriptLoaded(ad)) {
    const isOutsideIframe = isOutsideIframeAd(ad, format);
    const script = createScriptElement(ad, adm, isOutsideIframe, format);
    appendScriptElement(script, isOutsideIframe);
  } else {
    sendEventWithToken(AdEvent.CUSTOM, ad.token, SCRIPT_LOADED_LABEL);
  }
}
