<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Prebid Server</title>
    <script async src="//clickiocmp.com/t/consent_236053.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.20.3/video-js.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/2.1.0/videojs.ima.css" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            background: #f0f2f5;
            color: #1c1e21;
            line-height: 1.5;
        }

        .site-header {
            background: linear-gradient(90deg, #4267B2, #5B7BD5);
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 600;
            color: white;
            text-decoration: none;
        }

        .nav-link {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .nav-link:hover {
            opacity: 1;
        }

        .main-content {
            margin-top: 60px;
            padding-top: 20px;
            padding-bottom: 130px;
        }

        .content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .page-title {
            text-align: center;
            margin: 40px 0;
            font-size: 32px;
            color: #1c1e21;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin: 30px auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
        }

        .section-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: #1c1e21;
        }

        .section-text {
            color: #65676b;
            margin-bottom: 20px;
            font-size: 16px;
            line-height: 1.6;
        }

        .ad-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 20px auto;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            max-width: 1000px;
            text-align: center;
            position: relative;/
        }

        .ad-label {
            font-size: 12px;
            color: #65676b;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .native-ad {
            padding: 15px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .native-ad img {
            width: 100%;
            height: auto;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .native-ad-title {
            font-size: 18px;
            font-weight: bold;
            color: #1c1e21;
            margin-bottom: 10px;
        }

        .native-ad-desc {
            font-size: 14px;
            color: #65676b;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .native-ad-cta {
            display: inline-block;
            padding: 8px 20px;
            background: #4267B2;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .native-ad-cta:hover {
            background: #365899;
        }

        .footer-ad {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            height: 110px;
            z-index: 1000;
        }

        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 20px;
            color: #65676b;
            cursor: pointer;
            padding: 5px;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: 0.2s ease;
        }

        .close-button:hover {
            background: #f0f2f5;
        }

        #status-panel {
            position: fixed;
            bottom: 130px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: opacity 0.3s ease;
            opacity: 1;
        }

        #status-panel.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        .video-player-wrapper {
            position: relative;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .video-js {
            border-radius: 8px;
        }

        .hidden {
            display: none;
        }

        #header-ad,
        #article-ad {
            width: 100%;
            /* La largeur s'adapte à l'espace disponible */
            height: auto;
            /* La hauteur est définie dynamiquement */
            background-color: #f0f0f0;
            /* Couleur de fond pour indiquer la zone */
            border: 1px dashed #ccc;
            /* Bordure visible */
            display: flex;
            /* Pour centrer le texte ou le contenu */
            align-items: center;
            /* Centrer verticalement */
            justify-content: center;
            /* Centrer horizontalement */
            color: #999;
            font-family: Arial, sans-serif;
            font-size: 14px;
            font-style: italic;
            overflow: hidden;
            /* Éviter les débordements */
            position: relative;
            /* Permet de positionner des éléments internes */
        }

        #header-ad.empty:before,
        #article-ad.empty:before {
            content: "Espace publicitaire disponible";
            font-size: 14px;
            color: #aaa;
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="header-content">
            <a href="#" class="logo">Prebid Test</a>
            <nav>
                <a href="#guide" class="nav-link">Guide d'intégration</a>
                <a href="#documentation" class="nav-link">Documentation</a>
            </nav>
        </div>
    </header>

    <div class="main-content">
        <div class="content">
            <div class="ad-container">
                <div class="ad-label">Header Ad (728x90)</div>
                <div id="header-ad"></div>
            </div>

            <h1 class="page-title">Page de test Prebid Server</h1>

            <section class="section">
                <h2 class="section-title">À propos de cette page</h2>
                <p class="section-text">
                    Cette page de test vous permet de vérifier l'intégration de Prebid Server dans votre environnement.
                    Elle simule différents types de formats publicitaires (bannière, native, vidéo) et vous aide à
                    valider votre configuration.
                </p>
            </section>

            <div class="ad-container">
                <div class="ad-label">Banner Ad (728x90)</div>
                <div id="article-ad"></div>
            </div>

            <section class="section">
                <h2 class="section-title">Formats Publicitaires Disponibles</h2>
                <p class="section-text">
                    Nous prenons en charge plusieurs formats publicitaires pour répondre à vos besoins :
                </p>
                <ul>
                    <li>Bannières display standards (728x90, 300x250, etc.)</li>
                    <li>Publicités natives personnalisables</li>
                    <li>Publicités vidéo instream et outstream</li>
                    <li>Formats rich media</li>
                </ul>
            </section>

            <div class="ad-container">
                <div class="ad-container native-container">
                    <div class="ad-label">Native Ad</div>
                    <div id="native-ad"></div>
                </div>

                <!-- Template for Native Ad -->
                <template class="native-ad-template">
                    <div class="native-ad">
                        <img class="native-ad-image" src="" alt="">
                        <div class="native-ad-title"></div>
                        <div class="native-ad-desc"></div>
                        <a class="native-ad-cta" href="" target="_blank"></a>
                    </div>
                </template>
            </div>

            <section class="section">
                <h2 class="section-title">Intégration Vidéo</h2>
                <p class="section-text">
                    Notre solution vidéo utilise le Google IMA SDK pour une expérience publicitaire optimale.
                    Le player ci-dessous démontre l'intégration d'une publicité pre-roll avec possibilité de skip.
                </p>
            </section>

            <div class="ad-container">
                <div class="ad-label">Video Ad</div>
                <div id="video-ad">
                </div>
            </div>

            <section class="section">
                <h2 class="section-title">Panel de Debug</h2>
                <p class="section-text">
                    Le panel de statut en bas à droite affiche des informations en temps réel sur :
                </p>
                <ul>
                    <li>Le statut de chargement des publicités</li>
                    <li>La latence des requêtes</li>
                    <li>Les éventuelles erreurs</li>
                </ul>
            </section>
        </div>
    </div>

    <div class="footer-ad" id="footer-ad-container">
        <button class="close-button"
            onclick="document.getElementById('footer-ad-container').classList.add('hidden')">×</button>
        <div class="ad-container" style="margin: 0; box-shadow: none;">
            <div class="ad-label">Footer Ad (728x90)</div>
            <div id="footer-ad"></div>
        </div>
    </div>

    <!-- Prebid.js -->
    <script async src="https://niass.github.io/vpaidtest/test-prebid.js"></script>
    <!-- Video.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/video.js/7.20.3/video.min.js"></script>
    <!-- Plugin Videojs Contrib Ads (OBLIGATOIRE pour utiliser videojs-ima) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-contrib-ads/6.9.0/videojs-contrib-ads.min.js"></script>
    <!-- IMA SDK -->
    <script src="https://imasdk.googleapis.com/js/sdkloader/ima3.js"></script>
    <!-- VideoJS-IMA -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/videojs-ima/2.1.0/videojs.ima.min.js"></script>

    <script>
        var bliink_pbjs = bliink_pbjs || {};
        bliink_pbjs.que = bliink_pbjs.que || [];

        // Configuration des size mappings
        const getTagIdFromUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const tagId = urlParams.get('tagId');
            // Valeur par défaut si aucun tagId n'est trouvé dans l'URL
            return tagId || 'TELELOISIRS_FOOTER';
        };

        // Configuration des adUnits avec tagId dynamique
        const tagId = getTagIdFromUrl();
        // Définition des adUnits avec sizeMapping
        const adUnits = [
            {
                code: 'header-ad',
                ortb2Imp: {
                    tagid: tagId,
                },
                mediaTypes: {
                    banner: {
                        sizes: [[728, 90], [320, 50], [300, 100]]  // toutes les tailles possibles
                    }
                },
                bids: [
                    {
                        bidder: 'bliink',
                        params: {
                            tagId: tagId,
                        }
                    },
                ],

            },
            {
                code: 'video-ad',
                mediaTypes: {
                    video: {
                        context: 'outstream',
                        playerSize: [640, 480],
                        mimes: ['video/mp4'],
                        protocols: [1, 2, 3, 4, 5, 6, 7],
                        playbackmethod: [2],
                        skip: 1,
                        renderer: {
                            render: function (bid) {
                                console.log('Rendering outstream video');

                                const container = document.getElementById(bid.adUnitCode);
                                if (!container) {
                                    console.error('Container not found for ad unit:', bid.adUnitCode);
                                    return;
                                }

                                const videoContainer = document.createElement('div');
                                videoContainer.className = 'video-player-wrapper';

                                const videoElement = document.createElement('video');
                                videoElement.className = 'video-js vjs-default-skin';
                                videoElement.style.width = '100%';
                                videoElement.setAttribute('controls', true);
                                videoElement.setAttribute('playsinline', true);
                                videoElement.id = 'video-js-outstream-' + new Date().getTime();
                                videoContainer.appendChild(videoElement);

                                const adContainerDiv = document.createElement('div');
                                adContainerDiv.id = 'adContainer-' + new Date().getTime();
                                videoContainer.appendChild(adContainerDiv);

                                container.appendChild(videoContainer);

                                let adsInitialized = false;
                                const player = videojs(videoElement);

                                player.ready(function () {
                                    console.log('Player ready, setting up IMA');

                                    player.ima({
                                        id: videoElement.id,
                                        adsResponse: bid.vastXml,
                                        debug: true,
                                        loadVideoTimeout: 6000,
                                        vpaidMode: google.ima.ImaSdkSettings.VpaidMode.ENABLED,
                                        adContainer: adContainerDiv,
                                        autoPlayAdBreaks: true
                                    });

                                    player.on('adsready', function () {
                                        console.log('Ads are ready to be played');
                                        if (!adsInitialized) {
                                            adsInitialized = true;
                                            console.log('First time adsready - starting ad playback');
                                            player.ima.initializeAdDisplayContainer();
                                            player.ima.requestAds();

                                            // Force le début de la lecture après un court délai
                                            setTimeout(() => {
                                                console.log('Forcing playback start');
                                                player.play();
                                            }, 100);
                                        }
                                    });

                                    // Événements de debug
                                    player.on('adstart', function () {
                                        console.log('Ad playback has started');
                                    });

                                    player.on('playing', function () {
                                        console.log('Content/Ad is playing');
                                    });

                                    player.on('error', function (error) {
                                        console.error('Player error:', error);
                                        console.log('Error details:', player.error());
                                    });

                                    player.on('ima3-error', function (error) {
                                        console.error('IMA3 error:', error);
                                    });
                                });
                            }
                        }
                    }
                },
                bids: [{
                    bidder: 'bliink',
                    params: {
                        tagId: tagId
                    }
                }]
            },
            {
                code: 'native-ad',
                ortb2Imp: {
                    tagid: tagId, // C'est important que ça soit ajouté ic pourque ça soit inclus dans l'objet imp dans le payload et qu'on ait une pub
                },
                mediaTypes: {
                    native: {
                        title: { required: true, len: 80 },
                        image: { required: true, sizes: [1200, 627] },
                        sponsoredBy: { required: true },
                        clickUrl: { required: true },
                        body: { required: true },
                        cta: { required: true }
                    }
                },
                bids: [
                    {
                        bidder: 'bliink',
                        params: {
                            tagId: tagId,
                        }
                    }
                ],
            }
        ];


        // 1. Garder les fonctions de l'ancien code pour le mock et les rendus
        function addMockResponses(bids) {
            if (window.location.hostname !== 'localhost') return bids;

            // Ajouter les mocks comme dans l'ancienne version
            return bids.map(bid => {
                if (bid.adUnitCode === 'native-ad' && !bid.native) {
                    bid.native = {
                        // Reprendre le mock native de l'ancienne version
                    };
                } else if (bid.adUnitCode === 'video-ad' && !bid.vastUrl) {
                    bid.vastUrl = "https://vast.bliink.io/vp/bouygues/2024/Instream/vague2.xml";
                }
                return bid;
            });
        }

        // 2. Setup Prebid.js
        bliink_pbjs.que.push(() => {
            // Configuration unique et complète
            // D'abord déclarer les bidderSettings
            bliink_pbjs.setConfig({
                cache: {
                    url: 'https://prebid.adnxs.com/pbc/v1/cache'
                },
                ortb2: {
                    cur: ['EUR'], // ici tu indiques la ou les devises souhaitées
                    ssp: 'ss-DailyMotion'
                },
                // Configuration Server-to-Server (pour activer les appels au prebid server)
                s2sConfig: {
                    accountId: '1',
                    bidders: ['bliink'],
                    timeout: 1000,
                    adapter: 'prebidServer',
                    enabled: true,
                    endpoint: 'https://am-prebid.bliink.io/openrtb2/auction',
                    syncEndpoint: 'https://am-prebid.bliink.io/cookie_sync',
                    // extPrebid: {
                    //     bidders: {
                    //         bliink: {}
                    //     }
                    // }
                },
                // Configuration du consentement (sera mise à jour avec les données TCF)
                consentManagement: {
                    gdpr: {
                        cmpApi: 'iab',
                        defaultGdprScope: true,
                        debug: true
                    }
                },
                debug: true,
                gvlMapping: {
                    // Le key doit être exactement le nom du bidder
                    'bliink': 658 // L'ID GVL si Bliink en a un
                },
            });

            // Ajout des adUnits
            console.log("adUnits@@", adUnits);
            bliink_pbjs.addAdUnits(adUnits);
        });

        // 3. Vérification du consentement
        async function getTCFConsent() {
            return new Promise((resolve, reject) => {
                if (typeof window.__tcfapi !== 'function') {
                    reject(new Error('CMP non disponible'));
                    return;
                }
                window.__tcfapi('getTCData', 2, (tcData, success) => {
                    console.log('TCF data:', tcData);
                    console.log('Vendor consents:', tcData.vendor.consents);
                    console.log('Purpose consents:', tcData.purpose.consents);
                    if (success) resolve(tcData);
                    else reject(new Error('Impossible d\'obtenir le consentement'));
                });
            });
        }

        // 5. Fonctions de rendu
        function renderBanner(bid, adUnitCode) {
            console.log("renderBanner called", bid);

            if (!bid || !bid.adId) {
                console.error('No valid bid or adId found');
                return;
            }

            const container = document.getElementById(adUnitCode);

            if (!container) {
                console.error(`Container not found for banner ad with ID: ${adUnitCode}`);
                return;
            }

            try {
                // Créer l'iframe
                const iframe = document.createElement('iframe');
                iframe.frameBorder = '0';
                iframe.style.width = bid.width || bid.w || '100%';
                iframe.style.height = bid.height || bid.h || '250px';

                // Vider le conteneur et ajouter l'iframe
                container.innerHTML = '';
                container.appendChild(iframe);

                // Obtenir le document de l'iframe et rendre la publicité
                const iframeDoc = iframe.contentWindow.document;
                bliink_pbjs.renderAd(iframeDoc, bid.adId);

                console.log("Ad rendered in iframe", bid.adId);
            } catch (error) {
                console.error(`Error rendering banner ad for ${adUnitCode}:`, error);
            }
        }

        function renderNative(bid) {
            const container = document.getElementById(bid.impid);
            if (!container) return;

            const nativeData = JSON.parse(bid.adm);
            const template = document.querySelector('.native-ad-template');
            console.log("template", template);
            const content = template.content.cloneNode(true);

            const ad = content.querySelector('.native-ad');
            ad.querySelector('.native-ad-image').src = nativeData.assets.find(a => a.img)?.img?.url || '';
            ad.querySelector('.native-ad-title').textContent = nativeData.assets.find(a => a.title)?.title?.text || '';
            ad.querySelector('.native-ad-desc').textContent = nativeData.assets.find(a => a.data && a.data.type === 2)?.data?.value || '';
            const cta = ad.querySelector('.native-ad-cta');
            cta.textContent = nativeData.assets.find(a => a.data && a.data.type === 12)?.data?.value || 'En savoir plus';
            cta.href = nativeData.link?.url || '#';

            container.innerHTML = '';
            container.appendChild(content);
        }

        // 6. Gestion des réponses
        function handleBidResponses(bidResponses) {
            console.log("handleBidResponses called", bidResponses);

            // Validation initiale
            if (!bidResponses || typeof bidResponses !== 'object') {
                console.error("Invalid bid responses:", bidResponses);
                return;
            }

            // Utilisation de bliink_pbjs.getHighestCpmBids() pour obtenir les meilleures enchères
            const highestBids = bliink_pbjs.getHighestCpmBids();
            console.log("highestBids$$", highestBids);
            // Vérification si des enchères valides ont été trouvées
            if (!highestBids || !Array.isArray(highestBids) || highestBids.length === 0) {
                console.warn("No valid highest CPM bids found.");
                return;
            }

            // Parcourir les meilleures enchères
            highestBids.forEach((bestBid) => {
                const adUnitCode = bestBid.adUnitCode;

                // Log détaillé du gagnant
                console.log(`Winner for ${adUnitCode}:`, {
                    winningBidder: bestBid.bidderCode,
                    originalAdapter: bestBid.meta?.adaptercode || 'unknown',
                    cpm: bestBid.cpm,
                    mediaType: bestBid.mediaType
                });

                // Rendre la publicité en fonction du type
                try {
                    switch (bestBid.mediaType) {
                        case 'banner':
                            renderBanner(bestBid, adUnitCode);
                            break;
                        case 'video':
                            if (bestBid.renderer && typeof bestBid.renderer.render === 'function') {
                                bestBid.renderer.render(bestBid);
                            } else {
                                console.error('No renderer available for video ad');
                            }
                        case 'native':
                            renderNative(bestBid, adUnitCode);
                            break;
                        default:
                            console.warn(`Unsupported media type: ${bestBid.mediaType}`);
                    }
                } catch (error) {
                    console.error(`Error rendering ad for ${adUnitCode}:`, error);
                }
            });
        }

        // 7. Fonction principale d'initialisation
        async function initPrebidTest() {
            try {
                const tcData = await getTCFConsent();
                console.log("tcData", tcData);
                bliink_pbjs.que.push(() => {
                    // Déclencher les enchères
                    bliink_pbjs.requestBids({
                        bidsBackHandler: handleBidResponses
                    });
                });
            } catch (error) {
                console.error('Erreur d\'initialisation:', error);
            }
        }


        // 8. Démarrage au chargement de la page
        window.addEventListener('load', initPrebidTest);
    </script>
</body>

</html>